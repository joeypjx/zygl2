# 配置文件说明

## 概述

ZYGL2 系统使用 JSON 格式的配置文件来管理各项参数，支持灵活的配置管理和多环境部署。

## 配置文件位置

### 默认配置
- 文件路径：`config.json`（项目根目录）
- 使用方式：`./zygl2`

### 自定义配置
- 文件路径：任意位置
- 使用方式：`./zygl2 /path/to/custom-config.json`

## 配置项说明

### 1. 后端API配置 (backend)

```json
{
  "backend": {
    "api_url": "http://localhost:8080",
    "timeout_seconds": 10
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `api_url` | string | `http://localhost:8080` | 后端API服务器地址 |
| `timeout_seconds` | int | `10` | API请求超时时间（秒） |

### 2. 数据采集配置 (data_collector)

```json
{
  "data_collector": {
    "interval_seconds": 5
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `interval_seconds` | int | `5` | 数据采集周期（秒），建议范围：1-60 |

### 3. UDP通信配置 (udp)

```json
{
  "udp": {
    "multicast_address": "239.0.0.1",
    "state_broadcast_port": 5000,
    "command_listener_port": 5001,
    "broadcast_interval_ms": 1000
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `multicast_address` | string | `239.0.0.1` | UDP组播地址（D类地址：224.0.0.0-239.255.255.255） |
| `state_broadcast_port` | int | `5000` | 状态广播端口（前端接收） |
| `command_listener_port` | int | `5001` | 命令监听端口（前端发送） |
| `broadcast_interval_ms` | int | `1000` | 广播间隔（毫秒），建议范围：100-5000 |

### 4. Webhook配置 (webhook)

```json
{
  "webhook": {
    "listen_port": 9000
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `listen_port` | int | `9000` | Webhook HTTP服务器监听端口 |

### 5. 硬件拓扑配置 (hardware)

```json
{
  "hardware": {
    "chassis_count": 9,
    "boards_per_chassis": 14,
    "ip_base_pattern": "192.168.%d",
    "ip_offset": 100
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `chassis_count` | int | `9` | 机箱数量 |
| `boards_per_chassis` | int | `14` | 每机箱板卡数 |
| `ip_base_pattern` | string | `192.168.%d` | IP地址模式（预留，当前版本未使用） |
| `ip_offset` | int | `100` | IP偏移量（预留，当前版本未使用） |

### 6. 系统限制配置 (limits)

```json
{
  "limits": {
    "max_tasks_per_board": 8,
    "max_labels_per_stack": 8,
    "max_alert_messages": 16
  }
}
```

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `max_tasks_per_board` | int | `8` | 每块板卡最多任务数（预留，当前版本未使用） |
| `max_labels_per_stack` | int | `8` | 每个业务链路最多标签数（预留，当前版本未使用） |
| `max_alert_messages` | int | `16` | 每个告警最多消息数（预留，当前版本未使用） |

## 配置文件示例

### 开发环境配置 (config.dev.json)

```json
{
  "backend": {
    "api_url": "http://192.168.1.100:8080",
    "timeout_seconds": 15
  },
  "data_collector": {
    "interval_seconds": 3
  },
  "udp": {
    "multicast_address": "239.1.1.1",
    "state_broadcast_port": 6000,
    "command_listener_port": 6001,
    "broadcast_interval_ms": 500
  },
  "webhook": {
    "listen_port": 8888
  },
  "hardware": {
    "chassis_count": 9,
    "boards_per_chassis": 14,
    "ip_base_pattern": "192.168.%d",
    "ip_offset": 100
  },
  "limits": {
    "max_tasks_per_board": 8,
    "max_labels_per_stack": 8,
    "max_alert_messages": 16
  }
}
```

### 生产环境配置 (config.prod.json)

```json
{
  "backend": {
    "api_url": "http://10.0.0.100:8080",
    "timeout_seconds": 30
  },
  "data_collector": {
    "interval_seconds": 10
  },
  "udp": {
    "multicast_address": "239.255.0.1",
    "state_broadcast_port": 15000,
    "command_listener_port": 15001,
    "broadcast_interval_ms": 2000
  },
  "webhook": {
    "listen_port": 19000
  },
  "hardware": {
    "chassis_count": 9,
    "boards_per_chassis": 14,
    "ip_base_pattern": "192.168.%d",
    "ip_offset": 100
  },
  "limits": {
    "max_tasks_per_board": 8,
    "max_labels_per_stack": 8,
    "max_alert_messages": 16
  }
}
```

## 使用方法

### 1. 使用默认配置

```bash
./zygl2
```

系统会自动加载 `config.json`。

### 2. 使用自定义配置

```bash
# 开发环境
./zygl2 config.dev.json

# 生产环境
./zygl2 config.prod.json

# 绝对路径
./zygl2 /etc/zygl2/config.json
```

### 3. 配置验证

系统启动时会自动验证配置的有效性：

- 端口范围：1024-65535
- 数据采集间隔：≥ 1秒
- 广播间隔：≥ 100ms
- 机箱数量：1-100
- 每机箱板卡数：1-100

如果配置无效，系统会输出警告并使用默认值。

### 4. 配置不存在的处理

如果指定的配置文件不存在，系统会：

1. 输出警告信息
2. 使用内置默认配置
3. 继续正常启动

## 配置优先级

1. 命令行指定的配置文件
2. 默认配置文件 `config.json`
3. 内置默认配置（硬编码在 `ConfigLoader` 中）

## 注意事项

### 端口冲突
- 确保配置的端口未被其他程序占用
- UDP端口和Webhook端口不能相同
- 多个ZYGL2实例需要使用不同的端口配置

### 组播地址
- 必须使用D类IP地址（224.0.0.0-239.255.255.255）
- 避免使用保留地址段（如224.0.0.x）
- 建议使用239.0.0.0-239.255.255.255范围

### 性能调优
- **数据采集间隔**：过短会增加API服务器负载，过长会降低数据实时性
- **广播间隔**：过短会增加网络流量，过长会降低前端响应速度
- **超时时间**：根据网络环境调整，网络较差时适当增加

### JSON格式
- 确保配置文件是合法的JSON格式
- 使用UTF-8编码
- 注释不被支持（JSON标准不支持注释）

## 故障排查

### 配置加载失败
```
⚠️ 无法打开配置文件: config.json
   使用默认配置
```
**解决方案**：检查文件路径和权限，或创建配置文件。

### 配置验证失败
```
❌ 配置错误: UDP状态广播端口无效 (80)
⚠️ 配置验证失败，将使用默认值
```
**解决方案**：修改配置文件中的无效值，确保符合范围要求。

### 端口被占用
```
启动后台服务异常: Address already in use
```
**解决方案**：修改配置文件中的端口号，或停止占用端口的其他程序。

## 配置更新

如需修改配置：

1. 停止正在运行的ZYGL2程序（Ctrl+C）
2. 编辑配置文件
3. 重新启动程序

**注意**：配置不支持热更新，必须重启程序才能生效。

