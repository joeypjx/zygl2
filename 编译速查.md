# 项目编译速查表

> 快速参考：常用编译命令和选项

## 🚀 快速开始

```bash
# 1. 编译所有测试程序
make

# 2. 运行所有测试
make run_tests

# 3. 清理编译产物
make clean
```

## 📝 Makefile 命令

### 基本编译
```bash
make                # 编译所有测试程序
make test_deps      # 只编译依赖库测试
make test_domain    # 只编译领域层测试
make main           # 编译主程序（需要先创建src/main.cpp）
```

### 运行测试
```bash
make run_tests      # 编译并运行所有测试
./test_dependencies # 单独运行依赖库测试
./test_domain       # 单独运行领域层测试
```

### 清理
```bash
make clean          # 清理所有编译产物
```

### 编译选项
```bash
make DEBUG=1        # Debug模式（带调试信息，无优化）
make HTTPS=1        # 启用HTTPS支持（需要OpenSSL）
make ZLIB=1         # 启用压缩支持（需要zlib）
make CXX=clang++    # 使用clang++编译器
make -j4            # 使用4核并行编译
```

### 实用命令
```bash
make help           # 显示帮助信息
make info           # 显示编译配置
make stats          # 显示项目统计
make format         # 格式化代码（需要clang-format）
make check          # 静态分析（需要cppcheck）
```

## 🛠️ CMake 命令

### 基本使用
```bash
# 1. 创建构建目录
mkdir build && cd build

# 2. 配置项目
cmake ..

# 3. 编译
make

# 4. 运行测试
ctest
```

### 编译模式
```bash
# Debug模式
cmake -DCMAKE_BUILD_TYPE=Debug ..

# Release模式
cmake -DCMAKE_BUILD_TYPE=Release ..

# Release + 调试信息
cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
```

### 可选功能
```bash
# 启用HTTPS
cmake -DENABLE_HTTPS=ON ..

# 启用压缩
cmake -DENABLE_ZLIB=ON ..

# 构建测试程序
cmake -DBUILD_TESTS=ON ..

# 构建主程序（需要src/main.cpp）
cmake -DBUILD_MAIN=ON ..
```

### 多核编译
```bash
cmake --build . -j4      # 使用4核编译
make -j4                 # 或使用make
```

### 安装
```bash
sudo make install        # 安装到系统
sudo make uninstall      # 从系统卸载
```

## 💻 直接编译命令

### 依赖库测试
```bash
g++ -std=c++17 -I. test_dependencies.cpp -o test_dependencies -pthread
```

### 领域层测试
```bash
g++ -std=c++17 -I. test_domain.cpp -o test_domain -pthread
```

### 主程序（需要src/main.cpp）
```bash
g++ -std=c++17 -I. src/main.cpp -o zygl2 -pthread
```

### Debug模式
```bash
g++ -std=c++17 -I. -g -O0 -Wall -Wextra test_dependencies.cpp -o test_dependencies -pthread
```

### Release模式
```bash
g++ -std=c++17 -I. -O3 -DNDEBUG -Wall test_dependencies.cpp -o test_dependencies -pthread
```

### 启用HTTPS
```bash
g++ -std=c++17 -I. -DCPPHTTPLIB_OPENSSL_SUPPORT \
    test_dependencies.cpp -o test_dependencies \
    -pthread -lssl -lcrypto
```

## 🔧 常用组合

### 开发调试
```bash
make DEBUG=1            # Debug模式编译
make run_tests          # 运行测试
make clean && make      # 清理后重新编译
```

### 性能测试
```bash
make -j4                           # 多核编译
make CXXFLAGS="-O3 -march=native"  # 最高优化+CPU优化
```

### 完整功能
```bash
make HTTPS=1 ZLIB=1 -j4    # HTTPS + 压缩 + 多核编译
```

### 使用不同编译器
```bash
make CXX=clang++           # 使用clang++
make CXX=g++-13            # 使用特定版本的g++
```

## 🐛 调试技巧

### 查看编译细节
```bash
make -n                    # 显示将执行的命令（不实际执行）
make VERBOSE=1             # CMake：显示详细编译信息
```

### 单文件测试
```bash
g++ -std=c++17 -I. -fsyntax-only test_domain.cpp  # 只检查语法
g++ -std=c++17 -I. -E test_domain.cpp > output.i   # 预处理输出
```

### 查看符号
```bash
nm test_dependencies       # 查看符号表
ldd test_dependencies      # 查看依赖库（Linux）
otool -L test_dependencies # 查看依赖库（macOS）
```

## ❓ 常见问题

### Q: 找不到头文件
```bash
# 确保使用 -I. 包含当前目录
g++ -std=c++17 -I. your_source.cpp -o your_program -pthread
```

### Q: pthread链接错误
```bash
# 添加 -pthread
g++ -std=c++17 -I. your_source.cpp -o your_program -pthread
```

### Q: C++17特性不支持
```bash
# 确保使用 -std=c++17
g++ -std=c++17 ...

# 或升级编译器
# GCC: sudo apt install g++-11
# Clang: brew install llvm
```

### Q: OpenSSL链接错误
```bash
# macOS: 安装OpenSSL
brew install openssl

# Ubuntu: 安装OpenSSL
sudo apt install libssl-dev

# 编译时链接
g++ ... -DCPPHTTPLIB_OPENSSL_SUPPORT -lssl -lcrypto
```

## 📊 性能优化

### 编译速度优化
```bash
# 1. 多核编译
make -j$(nproc)          # Linux
make -j$(sysctl -n hw.ncpu)  # macOS

# 2. 使用ccache
export CXX="ccache g++"
make

# 3. 使用预编译头
g++ -std=c++17 -I. pch.h  # 预编译头文件
```

### 运行时优化
```bash
# 最高优化级别
make CXXFLAGS="-O3 -march=native -flto"

# 开启链接时优化
g++ -std=c++17 -I. -O3 -flto your_source.cpp -o your_program
```

## 📚 更多信息

- **完整文档**: `cat 编译指南.md`
- **Makefile帮助**: `make help`
- **CMake配置**: 查看 `CMakeLists.txt`
- **依赖库文档**: `cat third_party/README.md`

## 🎯 推荐工作流

### 方案1：纯Makefile（最简单）
```bash
make                # 编译
make run_tests      # 测试
make clean          # 清理
```

### 方案2：CMake（跨平台）
```bash
mkdir build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make -j4
ctest
```

### 方案3：开发模式（快速迭代）
```bash
# Debug模式，快速编译
make DEBUG=1

# 修改代码后重新编译
make clean && make DEBUG=1

# 运行测试
make run_tests
```

---

**提示**: 使用 `make help` 查看所有可用命令

