# 项目编译指南

## 项目概述

本项目是基于DDD架构的C++17 header-only项目，主要代码都在头文件中，需要创建main.cpp作为入口点来编译完整应用。

## 编译要求

### 系统要求
- **操作系统**: macOS / Linux / Windows (with MinGW)
- **编译器**: 
  - GCC 7+ (推荐 GCC 9+)
  - Clang 5+ (推荐 Clang 10+)
  - MSVC 2017+ (Windows)
- **C++标准**: C++17

### 依赖库
- **cpp-httplib**: HTTP客户端/服务器（已包含在third_party/）
- **nlohmann/json**: JSON解析库（已包含在third_party/）
- **pthread**: 线程库（系统自带）

### 可选依赖
- **OpenSSL**: 如需HTTPS支持
- **zlib**: 如需HTTP压缩支持

## 快速开始

### 1. 编译测试程序

#### 编译依赖库测试
```bash
# 编译
g++ -std=c++17 -I. test_dependencies.cpp -o test_dependencies -pthread

# 运行
./test_dependencies
```

#### 编译领域层测试
```bash
# 编译
g++ -std=c++17 -I. test_domain.cpp -o test_domain

# 运行
./test_domain
```

### 2. 使用Makefile编译（推荐）

```bash
# 编译所有测试程序
make

# 编译特定目标
make test_dependencies
make test_domain

# 清理
make clean
```

### 3. 使用CMake编译

```bash
# 创建构建目录
mkdir build && cd build

# 配置
cmake ..

# 编译
make

# 或使用多核编译
make -j4
```

## 编译选项说明

### 基本编译选项

```bash
g++ -std=c++17      # 使用C++17标准
    -I.             # 添加当前目录到包含路径
    -Wall           # 启用所有警告
    -Wextra         # 启用额外警告
    -O2             # 优化级别2
    -g              # 包含调试信息
    -pthread        # 链接pthread库
```

### Debug模式
```bash
g++ -std=c++17 -I. -g -O0 -Wall -Wextra your_source.cpp -o your_program -pthread
```

### Release模式
```bash
g++ -std=c++17 -I. -O3 -DNDEBUG -Wall your_source.cpp -o your_program -pthread
```

### 启用HTTPS支持
```bash
# macOS
g++ -std=c++17 -I. -DCPPHTTPLIB_OPENSSL_SUPPORT \
    your_source.cpp -o your_program \
    -pthread -lssl -lcrypto

# 需要先安装OpenSSL
brew install openssl
```

### 启用压缩支持
```bash
g++ -std=c++17 -I. -DCPPHTTPLIB_ZLIB_SUPPORT \
    your_source.cpp -o your_program \
    -pthread -lz
```

## 项目结构与编译

### 当前可编译的文件

| 文件 | 说明 | 编译命令 |
|------|------|----------|
| test_dependencies.cpp | 依赖库测试 | `make test_dependencies` |
| test_domain.cpp | 领域层测试 | `make test_domain` |
| src/main.cpp | 主程序（待创建）| `make main` |

### 创建主程序

目前项目缺少主程序入口。需要创建 `src/main.cpp` 来整合所有层的组件。

**示例主程序框架**:
```cpp
#include "src/domain/domain.h"
#include "src/infrastructure/infrastructure.h"
#include "src/application/application.h"
#include "src/interfaces/interfaces.h"

int main() {
    // 1. 初始化领域层
    // 2. 创建基础设施层（Repository、API客户端）
    // 3. 创建应用层服务
    // 4. 创建接口层（UDP、HTTP）
    // 5. 启动所有服务
    // 6. 主循环
    // 7. 优雅关闭
    return 0;
}
```

编译主程序：
```bash
g++ -std=c++17 -I. src/main.cpp -o zygl2 -pthread
```

## 使用Makefile

### Makefile功能

```bash
make              # 编译所有目标
make all          # 同上
make test_deps    # 只编译依赖库测试
make test_domain  # 只编译领域层测试
make main         # 编译主程序（需要先创建src/main.cpp）
make clean        # 清理所有编译产物
make run_tests    # 编译并运行所有测试
```

### Makefile配置

Makefile支持以下配置变量：

```makefile
# 编译器
CXX = g++                    # 或 clang++

# 编译选项
CXXFLAGS = -std=c++17 -I. -Wall -Wextra

# 优化级别
# Debug: -g -O0
# Release: -O3 -DNDEBUG

# 链接选项
LDFLAGS = -pthread
```

修改配置：
```bash
# 使用不同编译器
make CXX=clang++

# 使用Release模式
make CXXFLAGS="-std=c++17 -I. -O3 -DNDEBUG"

# 启用HTTPS
make CXXFLAGS="-std=c++17 -I. -DCPPHTTPLIB_OPENSSL_SUPPORT" \
     LDFLAGS="-pthread -lssl -lcrypto"
```

## 使用CMake

### CMake功能

CMake提供更强大的跨平台编译支持。

### 基本使用

```bash
# 创建构建目录
mkdir build && cd build

# 配置（Debug模式）
cmake -DCMAKE_BUILD_TYPE=Debug ..

# 配置（Release模式）
cmake -DCMAKE_BUILD_TYPE=Release ..

# 编译
cmake --build .

# 或使用make
make -j4
```

### CMake选项

```bash
# 启用HTTPS支持
cmake -DENABLE_HTTPS=ON ..

# 启用压缩支持
cmake -DENABLE_ZLIB=ON ..

# 指定编译器
cmake -DCMAKE_CXX_COMPILER=clang++ ..

# 指定安装路径
cmake -DCMAKE_INSTALL_PREFIX=/usr/local ..
```

### 安装

```bash
# 编译后安装
sudo make install

# 或使用cmake
sudo cmake --install .
```

## 常见问题

### Q1: 找不到头文件

**错误**:
```
fatal error: third_party/httplib.h: No such file or directory
```

**解决**:
确保编译时包含了项目根目录：
```bash
g++ -std=c++17 -I. your_source.cpp ...
```

### Q2: pthread链接错误

**错误**:
```
undefined reference to `pthread_create`
```

**解决**:
添加 `-pthread` 链接选项：
```bash
g++ ... -pthread
```

### Q3: C++17特性不支持

**错误**:
```
error: 'optional' is not a member of 'std'
```

**解决**:
确保使用C++17标准和支持的编译器：
```bash
g++ -std=c++17 ...
```

### Q4: OpenSSL链接错误

**错误**:
```
undefined reference to `SSL_library_init`
```

**解决**:
1. 安装OpenSSL：`brew install openssl` (macOS)
2. 链接OpenSSL库：
```bash
g++ ... -DCPPHTTPLIB_OPENSSL_SUPPORT -lssl -lcrypto
```

### Q5: 编译速度慢

**原因**: nlohmann/json.hpp很大（940KB），编译较慢

**优化方案**:
1. 使用预编译头文件（PCH）
2. 使用多核编译：`make -j4`
3. 使用ccache加速：`export CXX="ccache g++"`

## 编译性能优化

### 1. 使用ccache

```bash
# 安装ccache
brew install ccache  # macOS
sudo apt install ccache  # Ubuntu

# 配置
export CXX="ccache g++"
export CC="ccache gcc"

# 查看缓存统计
ccache -s
```

### 2. 多核编译

```bash
# Makefile
make -j$(nproc)  # Linux
make -j$(sysctl -n hw.ncpu)  # macOS

# CMake
cmake --build . -j4
```

### 3. 预编译头文件

在大型项目中使用PCH可以显著加速编译：

```cpp
// pch.h
#pragma once
#include "third_party/httplib.h"
#include "third_party/json.hpp"
#include <iostream>
#include <memory>
#include <vector>
#include <map>
// ... 其他常用头文件
```

```bash
# 预编译
g++ -std=c++17 -I. pch.h

# 使用
g++ -std=c++17 -I. -include pch.h your_source.cpp -o your_program
```

## 不同平台编译说明

### macOS

```bash
# 使用系统clang
clang++ -std=c++17 -I. test_dependencies.cpp -o test_dependencies -pthread

# 或使用homebrew gcc
brew install gcc
g++-13 -std=c++17 -I. test_dependencies.cpp -o test_dependencies -pthread
```

### Linux (Ubuntu/Debian)

```bash
# 安装编译工具
sudo apt update
sudo apt install build-essential cmake

# 编译
g++ -std=c++17 -I. test_dependencies.cpp -o test_dependencies -pthread
```

### Windows (MinGW)

```bash
# 使用MinGW
g++ -std=c++17 -I. test_dependencies.cpp -o test_dependencies.exe -static -pthread

# 或使用MSVC
cl /std:c++17 /EHsc /I. test_dependencies.cpp
```

## 代码检查工具

### 静态分析

```bash
# clang-tidy
clang-tidy src/**/*.h -- -std=c++17 -I.

# cppcheck
cppcheck --enable=all --std=c++17 src/
```

### 代码格式化

```bash
# clang-format
clang-format -i src/**/*.h src/**/*.cpp

# 使用Google风格
clang-format -style=Google -i src/**/*.h
```

## 性能分析

### 编译时性能分析

```bash
# 查看编译时间
time make

# 详细的编译统计
g++ -std=c++17 -I. -ftime-report test_dependencies.cpp -o test_dependencies -pthread
```

### 运行时性能分析

```bash
# gprof
g++ -std=c++17 -I. -pg your_source.cpp -o your_program -pthread
./your_program
gprof your_program gmon.out > analysis.txt

# valgrind
valgrind --tool=callgrind ./your_program
```

## 持续集成 (CI)

### GitHub Actions示例

```yaml
name: Build

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: sudo apt install -y build-essential
      - name: Build
        run: make
      - name: Test
        run: make run_tests
```

## 总结

### 推荐的编译流程

1. **开发阶段** - 使用Makefile快速编译测试
   ```bash
   make test_deps
   make test_domain
   ```

2. **调试阶段** - 使用Debug模式
   ```bash
   make CXXFLAGS="-std=c++17 -I. -g -O0 -Wall -Wextra"
   ```

3. **发布阶段** - 使用CMake + Release模式
   ```bash
   mkdir build && cd build
   cmake -DCMAKE_BUILD_TYPE=Release ..
   make -j4
   ```

### 下一步

1. 创建 `src/main.cpp` 主程序
2. 实现完整的应用逻辑
3. 编译并测试完整应用
4. 根据需要添加更多编译选项

---

**编译帮助**: 如遇到问题，请查看"常见问题"章节或参考第三方库文档  
**最后更新**: 2025-10-26

